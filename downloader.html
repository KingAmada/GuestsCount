<!doctype html>
<meta charset="utf-8">
<title>Download QR</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
  body{margin:0;display:grid;place-items:center;height:100vh;background:#0f172a;color:#fff;font-family:system-ui,Segoe UI,Roboto,Inter,sans-serif}
  .card{max-width:560px;background:#111827;border-radius:14px;padding:18px;box-shadow:0 10px 20px -10px rgba(2,6,23,.6);text-align:center}
  img{max-width:100%;height:auto;background:#fff;border-radius:10px;padding:8px}
  .row{margin-top:12px}
  .btn{display:inline-block;padding:10px 14px;border-radius:9999px;background:#22c55e;color:#fff;font-weight:700;text-decoration:none;border:0;cursor:pointer}
  .btn + .btn{margin-left:8px;background:#6366f1}
  .hint{opacity:.8;margin-top:8px}
  #qrbox{position:absolute;left:-9999px;top:-9999px} /* offscreen generator */
</style>

<div class="card">
  <h1>Event QR</h1>
  <div id="imgwrap"><p>Preparing your QR…</p></div>
  <div class="row">
    <a id="save" class="btn" download>Download</a>
    <button id="print" class="btn" type="button">Print</button>
  </div>
  <div class="hint">If download doesn’t start, click Download or long-press the image.</div>
</div>

<!-- hidden QR render target -->
<div id="qrbox"></div>

<script>
(function(){
  // Parse ?code=EVTXXXX (required)
  var params = new URLSearchParams(location.search);
  var code = (params.get('code')||'').trim();
  if(!code){ document.getElementById('imgwrap').innerHTML = '<p>No event code provided.</p>'; throw new Error('Missing code'); }

  // Build the QR payload your app expects
  var payload = JSON.stringify({ eventId: code });

  // Generate QR (big so the PNG is crisp)
  var q = new QRCode(document.getElementById('qrbox'), { text: payload, width: 1024, height: 1024 });

  // After QR is drawn, convert to PNG and try auto-download
  setTimeout(function(){
    var canvas = document.querySelector('#qrbox canvas');
    if(!canvas){ document.getElementById('imgwrap').innerHTML = '<p>Could not render QR.</p>'; return; }

    var dataUrl = canvas.toDataURL('image/png');
    var fileName = (code.replace(/[^\w.-]+/g,'_') || 'event-qr') + '.png';

    // Show image + wire buttons
    var img = new Image(); img.alt = 'Event QR'; img.src = dataUrl;
    var wrap = document.getElementById('imgwrap'); wrap.innerHTML=''; wrap.appendChild(img);

    var save = document.getElementById('save');
    save.href = dataUrl; save.download = fileName; save.rel='noopener';

    document.getElementById('print').onclick = function(){ print(); };

    // Try auto-download (some browsers block; UI remains as fallback)
    try { save.click(); } catch(_) {}
  }, 60);
})();
</script>
