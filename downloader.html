<!doctype html>
<meta charset="utf-8">
<title>Download</title>
<style>
  body{margin:0;display:grid;place-items:center;height:100vh;background:#0f172a;color:#fff;font-family:system-ui,Segoe UI,Roboto,Inter,sans-serif}
  .card{max-width:560px;background:#111827;border-radius:14px;padding:18px;box-shadow:0 10px 20px -10px rgba(2,6,23,.6);text-align:center}
  img{max-width:100%;height:auto;background:#fff;border-radius:10px;padding:8px}
  .row{margin-top:12px}
  .btn{display:inline-block;padding:10px 14px;border-radius:9999px;background:#22c55e;color:#fff;font-weight:700;text-decoration:none;border:0;cursor:pointer}
  .btn + .btn{margin-left:8px;background:#6366f1}
  .hint{opacity:.8;margin-top:8px}
</style>
<div class="card" id="ui" hidden>
  <h1>Event QR</h1>
  <div id="imgwrap"></div>
  <div class="row">
    <a id="save" class="btn">Download</a>
    <button id="print" class="btn">Print</button>
  </div>
  <div class="hint">If download doesnâ€™t start, click Download or long-press the image.</div>
</div>
<script>
(function(){
  function dataUrlToBlob(url){
    var parts = String(url).split(',');
    var mime = (/^data:(.*?);base64/.exec(parts[0])||[])[1] || 'image/png';
    var bin  = atob(parts[1]||'');
    var len  = bin.length, u8 = new Uint8Array(len);
    for (var i=0;i<len;i++) u8[i] = bin.charCodeAt(i);
    return new Blob([u8], {type:mime});
  }

  function ready(){
    try { window.opener && window.opener.postMessage({source:'QR_DOWNLOADER', type:'ready'}, '*'); } catch(_) {}
  }

  window.addEventListener('message', function(ev){
    // Accept from any origin you use (Wix page / your iframe)
    var data = ev.data || {};
    if (data && data.type === 'download-qr' && data.dataUrl){
      var fileName = (data.fileName || 'event-qr') + '.png';
      var blob = data.dataUrl.indexOf('data:')===0 ? dataUrlToBlob(data.dataUrl) : null;
      var href = blob ? (URL || window.URL).createObjectURL(blob) : data.dataUrl;

      // Show image + buttons
      var img = new Image(); img.alt = 'Event QR'; img.src = href;
      document.getElementById('imgwrap').innerHTML = ''; 
      document.getElementById('imgwrap').appendChild(img);
      document.getElementById('ui').hidden = false;

      // Wire buttons
      var save = document.getElementById('save');
      save.href = href; save.download = fileName; save.rel = 'noopener';

      document.getElementById('print').onclick = function(){ print(); };

      // Auto-start download (fallback to visible UI)
      setTimeout(function(){ try{ save.click(); }catch(_){} }, 60);

      // Revoke later
      setTimeout(function(){ try{ (URL||window.URL).revokeObjectURL(href); }catch(_){} }, 10000);
    }
  });

  ready();
})();
</script>
